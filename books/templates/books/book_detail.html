{% extends "base.html" %}
{% load static %}
{% load crispy_forms_tags %}

{% block title %}{{ book.book_title }} - Ink & Read{% endblock %}

{% block meta_description %}{{ book.book_description|truncatewords:20 }}{% endblock %}

{% block og_type %}book{% endblock %}

{% block og_image %}
    {% if book.cover_image and book.cover_image != 'placeholder' %}
        <meta property="og:image" content="{{ book.cover_image.url }}">
    {% endif %}
{% endblock %}

{% block breadcrumb %}
    <nav class="breadcrumb-nav" aria-label="Breadcrumb navigation">
        <div class="container">
            <div class="breadcrumb">
                <a href="/" aria-label="Go to home page">üè† Home</a>
                <span class="breadcrumb-separator" aria-hidden="true">‚Ä∫</span>
                <a href="/books/" aria-label="Go to books collection">üìö Books</a>
                <span class="breadcrumb-separator" aria-hidden="true">‚Ä∫</span>
                <span aria-current="page">{{ book.book_title }}</span>
            </div>
        </div>
    </nav>
{% endblock %}

{% block content %}

    <header class="page-header">
        <div class="container">
            <h1 class="books-collection">Book details</h1>
            <p class="profile-subtitle">Learn more about this book here {{ user.get_full_name|default:user.username|capfirst }}!</p>
        </div>
    </header>
    <!-- Main Book Detail Container -->
    <article class="book-detail-container" role="main">
        <!-- Book Header with Cover and Basic Info -->
        <section class="book-header">
            <div class="book-cover-section">
                {% if book.cover_image and book.cover_image != 'placeholder' %}
                    <img src="{{ book.cover_image.url }}" 
                         alt="{{ book.cover_image_alt|default:'Cover of '|add:book.book_title }}" 
                         class="book-cover-large"
                         loading="eager">
                {% else %}
                    <div class="book-cover-placeholder-large" 
                         role="img" 
                         aria-label="Cover image not available for {{ book.book_title }}">
                        üìñ
                    </div>
                {% endif %}
            </div>
            
            <div class="book-info">
                <h1 class="book-title-large">{{ book.book_title }}</h1>
                <p class="book-author-large">by {{ book.author }}</p>
                
                <div class="book-rating-large">
                    <span class="stars" aria-label="Rating: {{ book.average_rating }} out of 5 stars">
                        {% for i in "12345" %}
                            {% if book.average_rating >= forloop.counter %}‚≠ê{% else %}‚òÜ{% endif %}
                        {% endfor %}
                    </span>
                    <span class="rating-text">{{ book.average_rating }}/5</span>
                </div>

                <!-- User Actions (Wishlist & Read Status) -->
                {% if user.is_authenticated %}
                    <div class="d-flex gap-2 mt-3">
                        <!-- Wishlist Button -->
                        <form method="post" action="{% url 'toggle_favorite' book.id %}" style="display: inline;">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-primary">
                                {% if user_book_status and user_book_status.is_favorite %}
                                    In Wishlist
                                {% else %}
                                    Add to Wishlist
                                {% endif %}
                            </button>
                        </form>
                        
                        <!-- Read Status Button -->
                        <form method="post" action="{% url 'toggle_read' book.id %}" style="display: inline;">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-primary">
                                {% if user_book_status and user_book_status.is_read %}
                                    Read
                                {% else %}
                                    Mark as Read
                                {% endif %}
                            </button>
                        </form>
                    </div>
                {% else %}
                    <div class="alert alert-info mt-3">
                        <strong><a href="{% url 'account_login' %}">Log in</a> to add to wishlist and track your reading!</strong>
                    </div>
                {% endif %}
            </div>
        </section>


        <!-- Book Content -->
        <div class="book-content">
            <!-- Description Section -->
            <section>
                <h2 class="section-title">
                    <span>About This Book</span>
                </h2>
                <div class="book-description-full">
                    {{ book.book_description|safe|linebreaks }}
                </div>
            </section>

            <section>
                <!-- Rating Form Section (Only for authenticated users) -->
                {% if user.is_authenticated %}
                    <h2 class="section-title">
                        <span>Rate This Book</span>
                    </h2>
                    
                    <form method="post" class="rating-form">
                        {% csrf_token %}
                        
                        <div class="form-group">
                            {{ book_rating_form.score.label_tag }}
                            {{ book_rating_form.score }}
                            {% if book_rating_form.score.help_text %}
                                <small class="form-text text-muted">{{ book_rating_form.score.help_text }}</small>
                            {% endif %}
                        </div>

                        {% if user_rating %}
                        <div class="alert alert-info">
                            <strong>Your current rating:</strong> {{ user_rating.score }}/5 stars
                        </div>
                        {% endif %}

                        <div class="d-flex gap-2 align-items-stretch">
                            <button type="submit" name="rating_submit" class="btn btn-primary">
                                {% if user_rating %}Update Rating{% else %}Submit Rating{% endif %}
                            </button>
                        </form>
                            
                        <!-- Delete Rating Button (Only show if user has rated the book) -->
                        {% if user_rating %}
                            <form method="post" action="{% url 'delete_rating' slug=book.slug %}" class="delete-rating-form d-flex" style="margin: 0;">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-primary" 
                                        onclick="return confirm('Are you sure you want to delete your rating? This action cannot be undone.')">
                                     Delete My Rating
                                </button>
                            </form>
                        {% endif %}
                        </div>
                    
                {% else %}
                    <div class="alert alert-warning">
                        <strong>Please <a href="{% url 'account_login' %}">log in</a> to rate this book.</strong>
                    </div>
                {% endif %}


                <!-- Display Approved Reviews -->
                {% if approved_reviews %}
                    <section>
                        <h2 class="section-title">
                            <span>Reader Reviews</span>
                        </h2>
                        
                        <div class="reviews-section">
                            {% for review in approved_reviews %}
                                <div class="review-card">
                                    <div class="review-header">
                                        <strong>{{ review.user.username|title }}</strong>
                                        <small class="text-muted">{{ review.created_at|date:"F j, Y" }}</small>
                                    </div>
                                    <div class="review-content">
                                        {{ review.review|safe }}
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    </section>
                {% endif %}

                <!-- Review Form Section (Only for authenticated users) -->
                <section>
                    {% if user.is_authenticated %}
                        <h2 class="section-title">
                            <span>Review This Book</span>
                        </h2>
                        
                        
                        <form method="post" class="review-form">
                            {% csrf_token %}
                            <div class="form-group">
                                {{ book_review_form.review.label_tag }}
                                {{ book_review_form.review }}
                                {% if book_review_form.review.help_text %}
                                    <small class="form-text text-muted">{{ book_review_form.review.help_text }}</small>
                                {% endif %}
                            </div>
                            {% if user_review %}
                            <div class="alert alert-info">
                                <strong>Your review status:</strong> 
                                {% if user_review.approved %}
                                    Published
                                {% else %}
                                    Pending approval
                                {% endif %}
                            </div>
                        {% endif %}

                            <div class="d-flex gap-2 align-items-stretch">
                                <button type="submit" name="review_submit" class="btn btn-primary">
                                    {% if user_review %}Update Review{% else %}Submit Review{% endif %}
                                </button>
                            </form>

                            <!-- Delete Review Button (Only show if user has written a review) -->
                            {% if user_review %}
                                <form method="post" action="{% url 'delete_review' slug=book.slug %}" class="delete-review-form d-flex" style="margin: 0;">
                                    {% csrf_token %}
                                    <button type="submit" class="btn btn-primary" 
                                            onclick="return confirm('Are you sure you want to delete your review? This action cannot be undone.')">
                                        Delete My Review
                                    </button>
                                </form>
                            {% endif %}
                            </div>
                        
                    {% else %}
                        <div class="alert alert-warning">
                            <strong>Please <a href="{% url 'account_login' %}">log in</a> to review this book.</strong>
                        </div>
                    {% endif %}
                </section>
            </section>

        </div>
    </article>
{% endblock %}