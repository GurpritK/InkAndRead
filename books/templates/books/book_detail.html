{% extends "base.html" %}
{% load static %}
{% load crispy_forms_tags %}

{% block title %}{{ book.book_title }} - Ink & Read{% endblock %}

{% block meta_description %}{{ book.book_description|truncatewords:20 }}{% endblock %}

{% block og_type %}book{% endblock %}

{% block og_image %}
    {% if book.cover_image and book.cover_image != 'placeholder' %}
        <meta property="og:image" content="{{ book.cover_image.url }}">
    {% endif %}
{% endblock %}

{% block breadcrumb %}
    <nav class="breadcrumb-nav" aria-label="Breadcrumb navigation">
        <div class="container">
            <div class="breadcrumb">
                <a href="/" aria-label="Go to home page">üè† Home</a>
                <span class="breadcrumb-separator" aria-hidden="true">‚Ä∫</span>
                <a href="/books/" aria-label="Go to books collection">üìö Books</a>
                <span class="breadcrumb-separator" aria-hidden="true">‚Ä∫</span>
                <span aria-current="page">{{ book.book_title }}</span>
            </div>
        </div>
    </nav>
{% endblock %}

{% block content %}
    <!-- Main Book Detail Container -->
    <article class="book-detail-container" role="main">
        <!-- Book Header with Cover and Basic Info -->
        <header class="book-header">
            <div class="book-cover-section">
                {% if book.cover_image and book.cover_image != 'placeholder' %}
                    <img src="{{ book.cover_image.url }}" 
                         alt="{{ book.cover_image_alt|default:'Cover of '|add:book.book_title }}" 
                         class="book-cover-large"
                         loading="eager">
                {% else %}
                    <div class="book-cover-placeholder-large" 
                         role="img" 
                         aria-label="Cover image not available for {{ book.book_title }}">
                        üìñ
                    </div>
                {% endif %}
            </div>
            
            <div class="book-info">
                <h1 class="book-title-large">{{ book.book_title }}</h1>
                <p class="book-author-large">by {{ book.author }}</p>
                
                <div class="book-rating-large">
                    <span class="stars" aria-label="Rating: {{ book.average_rating }} out of 5 stars">
                        {% for i in "12345" %}
                            {% if book.average_rating >= forloop.counter %}‚≠ê{% else %}‚òÜ{% endif %}
                        {% endfor %}
                    </span>
                    <span class="rating-text">{{ book.average_rating }}/5</span>
                </div>
            </div>
        </header>

        <!-- Book Content -->
        <div class="book-content">
            <!-- Description Section -->
            <section>
                <h2 class="section-title">
                    üìñ <span>About This Book</span>
                </h2>
                <div class="book-description-full">
                    {{ book.book_description|linebreaks }}
                </div>
            </section>

            <!-- Book Details -->
            <section>
                <h2 class="section-title">
                    üìã <span>Book Details</span>
                </h2>
                
                <div class="book-details">
                    <div class="detail-card">
                        <div class="detail-title">Author</div>
                        <div class="detail-content">{{ book.author }}</div>
                    </div>
                    
                    <div class="detail-card">
                        <div class="detail-title">Average Rating</div>
                        <div class="detail-content">
                            {{ book.average_rating }}/5.0 
                            <span class="sr-only">({{ book.average_rating }} out of 5 stars)</span>
                        </div>
                    </div>
                </div>

                <!-- Rating Form Section (Only for authenticated users) -->
                {% if user.is_authenticated %}
                    <h2 class="section-title">
                        <span>Rate This Book</span>
                    </h2>
                    
                    {% if user_rating %}
                        <div class="alert alert-info">
                            <strong>Your current rating:</strong> {{ user_rating.score }}/5 stars
                        </div>
                    {% endif %}
                    
                    <form method="post" class="rating-form">
                        {% csrf_token %}
                        <div class="form-group">
                            {{ book_rating_form.score.label_tag }}
                            {{ book_rating_form.score }}
                            {% if book_rating_form.score.help_text %}
                                <small class="form-text text-muted">{{ book_rating_form.score.help_text }}</small>
                            {% endif %}
                        </div>
                        <button type="submit" name="rating_submit" class="btn btn-primary">
                            {% if user_rating %}Update Rating{% else %}Submit Rating{% endif %}
                        </button>
                    </form>
                    
                    <!-- Delete Rating Button (Only show if user has rated the book) -->
                    {% if user_rating %}
                        <form method="post" action="{% url 'delete_rating' slug=book.slug %}" class="delete-rating-form mt-2">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-outline-danger btn-sm" 
                                    onclick="return confirm('Are you sure you want to delete your rating? This action cannot be undone.')">
                                 Delete My Rating
                            </button>
                        </form>
                    {% endif %}
                {% else %}
                    <div class="alert alert-warning">
                        <strong>Please <a href="{% url 'account_login' %}">log in</a> to rate this book.</strong>
                    </div>
                {% endif %}


                <!-- Display Approved Reviews -->
                {% if approved_reviews %}
                    <section>
                        <h2 class="section-title">
                            üìö <span>Reader Reviews</span>
                        </h2>
                        
                        <div class="reviews-section">
                            {% for review in approved_reviews %}
                                <div class="review-card">
                                    <div class="review-header">
                                        <strong>{{ review.user.username|title }}</strong>
                                        <small class="text-muted">{{ review.created_at|date:"F j, Y" }}</small>
                                    </div>
                                    <div class="review-content">
                                        {{ review.review|safe }}
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    </section>


                <!-- Review Form Section (Only for authenticated users) -->
                {% if user.is_authenticated %}
                    <h2 class="section-title">
                        üí¨ <span>Review This Book</span>
                    </h2>
                    
                    {% if user_review %}
                        <div class="alert alert-info">
                            <strong>Your review status:</strong> 
                            {% if user_review.approved %}
                                Published
                            {% else %}
                                Pending approval
                            {% endif %}
                        </div>
                    {% endif %}
                    
                    <form method="post" class="review-form">
                        {% csrf_token %}
                        <div class="form-group">
                            {{ book_review_form.review.label_tag }}
                            {{ book_review_form.review }}
                            {% if book_review_form.review.help_text %}
                                <small class="form-text text-muted">{{ book_review_form.review.help_text }}</small>
                            {% endif %}
                        </div>
                        <button type="submit" name="review_submit" class="btn btn-primary">
                            {% if user_review %}Update Review{% else %}Submit Review{% endif %}
                        </button>
                    </form>
                    
                    <!-- Delete Review Button (Only show if user has written a review) -->
                    {% if user_review %}
                        <form method="post" action="{% url 'delete_review' slug=book.slug %}" class="delete-review-form mt-2">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-outline-danger btn-sm" 
                                    onclick="return confirm('Are you sure you want to delete your review? This action cannot be undone.')">
                                üóëÔ∏è Delete My Review
                            </button>
                        </form>
                    {% endif %}
                {% else %}
                    <div class="alert alert-warning">
                        <strong>Please <a href="{% url 'account_login' %}">log in</a> to review this book.</strong>
                    </div>
                {% endif %}
            </section>
            {% endif %}

        </div>
    </article>
{% endblock %}